<!DOCTYPE html>
<html>
<head>
  <title>File Manager</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
  <h2>Register</h2>
  <input id="reg-username" placeholder="Username">
  <input id="reg-password" type="password" placeholder="Password">
  <button onclick="signup()">Sign Up</button>

  <h2>Login</h2>
  <input id="login-username" placeholder="Username">
  <input id="login-password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>

  <h2>Upload File</h2>
  <input type="file" id="file-upload">
  <button onclick="upload()">Upload</button>

  <h2>Files</h2>
  <ul id="file-list"></ul>

  <script>
    let token = "";

    function showMessage(msg) {
      alert(typeof msg === 'object' ? JSON.stringify(msg, null, 2) : msg);
    }

    function signup() {
      const username = document.getElementById('reg-username').value;
      const password = document.getElementById('reg-password').value;
      axios.post('http://localhost:8000/register', { username, password })
        .then(res => showMessage(res.data))
        .catch(err => showMessage(err.response?.data?.detail || err.message));
    }

    function login() {
      const form = new FormData();
      form.append('username', document.getElementById('login-username').value);
      form.append('password', document.getElementById('login-password').value);
      form.append('grant_type', 'password');

      axios.post('http://localhost:8000/token', form)
        .then(res => {
          token = res.data.access_token;
          showMessage("Login successful");
          listFiles();
        })
        .catch(err => showMessage(err.response?.data?.detail || err.message));
    }

    function upload() {
      const fileInput = document.getElementById('file-upload');
      if (fileInput.files.length === 0) return showMessage("No file selected");

      const formData = new FormData();
      formData.append('file', fileInput.files[0]);

      axios.post('http://localhost:8000/upload', formData, {
        headers: { Authorization: `Bearer ${token}` }
      })
        .then(res => {
          showMessage("Upload successful: " + res.data.filename);
          listFiles();
        })
        .catch(err => showMessage(err.response?.data?.detail || err.message));
    }

    function listFiles() {
      axios.get('http://localhost:8000/files', {
        headers: { Authorization: `Bearer ${token}` }
      })
        .then(res => {
          const list = document.getElementById('file-list');
          list.innerHTML = '';
          res.data.forEach(file => {
            const li = document.createElement('li');
            li.innerHTML = `
              ${file}
              <button onclick="download('${file}')">Download</button>
              <button onclick="remove('${file}')">Delete</button>
            `;
            list.appendChild(li);
          });
        });
    }

    function download(filename) {
      axios.get('http://localhost:8000/download/' + filename, {
        responseType: 'blob',
        headers: { Authorization: `Bearer ${token}` }
      })
      .then(res => {
        const url = window.URL.createObjectURL(new Blob([res.data]));
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
      });
    }

    function remove(filename) {
      axios.delete('http://localhost:8000/delete/' + filename, {
        headers: { Authorization: `Bearer ${token}` }
      })
        .then(() => {
          showMessage(`${filename} deleted`);
          listFiles();
        });
    }
  </script>
</body>
</html>
